import React, { useState, useEffect, useContext } from 'react';
import {
  getTrades,
  getDashboard,
  createTrade,
  updateTrade,
  deleteTrade,
} from '../services/api';
import CloseTradeModal from './CloseTradeModal';
import { ActiveAccountContext } from '../context/ActiveAccountContext';
import axios from 'axios';

// MODAL DE TRADE OPCIONES CON ESTILO
function AddTradeModal({
  isOpen,
  onClose,
  onTradeAdded,
  editingTrade,
  activeAccount,
  loadingActiveAccount,
}) {
  const [formData, setFormData] = useState({
    account_id: activeAccount ? activeAccount.account_id : 1,
    symbol: '',
    trade_type: 'CSP',
    contracts: 1,
    strike_price: '',
    premium_per_share: '',
    open_date: new Date().toISOString().split('T')[0],
    expiration_date: '',
    fees: '',
  });

  useEffect(() => {
    if (isOpen && !editingTrade) {
      setFormData((prev) => ({
        ...prev,
        account_id: activeAccount.account_id,
        symbol: '',
        trade_type: 'CSP',
        contracts: 1,
        strike_price: '',
        premium_per_share: '',
        open_date: new Date().toISOString().split('T')[0],
        expiration_date: '',
        fees: '',
      }));
    }
  }, [activeAccount, isOpen, editingTrade]);

  useEffect(() => {
    if (editingTrade && isOpen) {
      setFormData({
        account_id: editingTrade.account_id,
        symbol: editingTrade.symbol,
        trade_type: editingTrade.trade_type,
        contracts: editingTrade.contracts,
        strike_price: editingTrade.strike_price.toString(),
        premium_per_share: editingTrade.premium_per_share.toString(),
        open_date: editingTrade.open_date.split('T')[0],
        expiration_date: editingTrade.expiration_date.split('T')[0],
        fees: editingTrade.fees ? editingTrade.fees.toString() : '',
      });
    }
  }, [editingTrade, isOpen]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const payload = {
        ...formData,
        account_id: activeAccount.account_id,
        strike_price: parseFloat(formData.strike_price),
        premium_per_share: parseFloat(formData.premium_per_share),
        contracts: parseInt(formData.contracts),
        fees: parseFloat(formData.fees) || 0,
      };
      if (editingTrade) {
        await updateTrade(editingTrade.trade_id, payload);
      } else {
        await createTrade(payload);
      }
      onTradeAdded();
      onClose();
    } catch (error) {
      const errorMessage =
        error.response?.data?.message || error.message || 'Error desconocido';
      alert('Error al guardar trade: ' + errorMessage);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <h2>{editingTrade ? 'Editar Trade' : 'Nuevo Trade'}</h2>
        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label>Símbolo:</label>
            <input
              type="text"
              className="form-control"
              value={formData.symbol}
              onChange={e => setFormData({ ...formData, symbol: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Tipo:</label>
            <select
              className="form-control"
              value={formData.trade_type}
              onChange={e => setFormData({ ...formData, trade_type: e.target.value })}
            >
              <option value="CSP">Cash-Secured Put (CSP)</option>
              <option value="CC">Covered Call (CC)</option>
            </select>
          </div>
          <div className="form-group">
            <label>Contratos:</label>
            <input
              type="number"
              min="1"
              className="form-control"
              value={formData.contracts}
              onChange={e => setFormData({ ...formData, contracts: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Precio de Strike:</label>
            <input
              type="number"
              step="0.01"
              className="form-control"
              value={formData.strike_price}
              onChange={e => setFormData({ ...formData, strike_price: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Prima por acción:</label>
            <input
              type="number"
              step="0.01"
              className="form-control"
              value={formData.premium_per_share}
              onChange={e => setFormData({ ...formData, premium_per_share: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Fecha de apertura:</label>
            <input
              type="date"
              className="form-control"
              value={formData.open_date}
              onChange={e => setFormData({ ...formData, open_date: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Fecha de expiración:</label>
            <input
              type="date"
              className="form-control"
              value={formData.expiration_date}
              onChange={e => setFormData({ ...formData, expiration_date: e.target.value })}
            />
          </div>
          <div className="form-group">
            <label>Comisiones:</label>
            <input
              type="number"
              step="0.01"
              className="form-control"
              value={formData.fees}
              onChange={e => setFormData({ ...formData, fees: e.target.value })}
            />
          </div>
          <div className="form-actions">
            <button type="submit" className="btn btn-primary">{editingTrade ? 'Actualizar' : 'Crear'}</button>
            <button type="button" className="btn btn-secondary" onClick={onClose}>Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  );
}

// MODAL DE ACCIONES CON ESTILO
function StockTradeModal({ isOpen, onClose }) {
  const { activeAccount } = useContext(ActiveAccountContext);
  const [formData, setFormData] = useState({
    account_id: activeAccount ? activeAccount.account_id : 1,
    symbol: '',
    type: 'compra',
    quantity: '',
    price_per_share: '',
    operation_date: new Date().toISOString().split('T')[0],
    fees: '',
  });

  useEffect(() => {
    if (isOpen) {
      setFormData((prev) => ({
        ...prev,
        account_id: activeAccount.account_id,
        symbol: '',
        type: 'compra',
        quantity: '',
        price_per_share: '',
        operation_date: new Date().toISOString().split('T')[0],
        fees: '',
      }));
    }
  }, [activeAccount, isOpen]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const payload = {
        ...formData,
        quantity: parseInt(formData.quantity),
        price_per_share: parseFloat(formData.price_per_share),
        fees: parseFloat(formData.fees) || 0,
      };
      // Aquí deberías llamar al endpoint correspondiente para compra/venta de acciones.
      // await createStockTrade(payload);
      alert('Operación de acciones registrada (funcionalidad simulada)');
      onClose();
    } catch (error) {
      const errorMessage =
        error.response?.data?.message || error.message || 'Error desconocido';
      alert('Error al guardar operación: ' + errorMessage);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <h2>Compra/Venta de Acciones</h2>
        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label>Símbolo:</label>
            <input
              type="text"
              className="form-control"
              value={formData.symbol}
              onChange={e => setFormData({ ...formData, symbol: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Tipo:</label>
            <select
              className="form-control"
              value={formData.type}
              onChange={e => setFormData({ ...formData, type: e.target.value })}
            >
              <option value="compra">Compra</option>
              <option value="venta">Venta</option>
            </select>
          </div>
          <div className="form-group">
            <label>Cantidad de Acciones:</label>
            <input
              type="number"
              min="1"
              className="form-control"
              value={formData.quantity}
              onChange={e => setFormData({ ...formData, quantity: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Precio por acción:</label>
            <input
              type="number"
              step="0.01"
              className="form-control"
              value={formData.price_per_share}
              onChange={e => setFormData({ ...formData, price_per_share: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Fecha de operación:</label>
            <input
              type="date"
              className="form-control"
              value={formData.operation_date}
              onChange={e => setFormData({ ...formData, operation_date: e.target.value })}
              required
            />
          </div>
          <div className="form-group">
            <label>Comisiones:</label>
            <input
              type="number"
              step="0.01"
              className="form-control"
              value={formData.fees}
              onChange={e => setFormData({ ...formData, fees: e.target.value })}
            />
          </div>
          <div className="form-actions">
            <button type="submit" className="btn btn-primary">Registrar</button>
            <button type="button" className="btn btn-secondary" onClick={onClose}>Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  );
}

function TradesPage() {
  // ... mantienen todas tus funciones y JSX igual ...
  // No es necesario modificar nada más en la página principal.
  // Si necesitas ajustes adicionales, indícalo.

  // PEGAR AQUÍ EL RESTO DE TU FUNCIÓN TradesPage COMO YA LA TIENES
  // (No hay cambios aquí en la tabla ni en los handlers, sólo en los modales)

  // ... Pega desde 'function TradesPage() {' hasta 'export default TradesPage;'
}

// El resto del archivo se mantiene igual (tabla, modals, etc.)
export default TradesPage;
